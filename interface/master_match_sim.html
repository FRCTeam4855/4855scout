<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Simulate Match :: 4855 Scouting</title>
		<script type="text/javascript"></script>
    	<link href="../data/styles.css" rel="stylesheet" type="text/css">
	</head>
	<body onload="load_data()">
		<h1>SIMULATE MATCH</h1>
		<p>
			Use this interface to simulate any matchup between two alliances. A simulated score breakdown will also be displayed, as well as turning point statistics, weak points, and predicted defenders.
		</p>
		
		<form id="simulateForm" action="" onSubmit="return false">
			<fieldset id="redAllianceForm" class="allianceForm">
				<h3>RED ALLIANCE</h3>
				<select name="redTeam1" id="redTeam1" class="teamSelect" required>
					 <option value="" disabled selected>Pick a team</option>
				</select><br>
				<select name="redTeam2" id="redTeam2" class="teamSelect" required>
					<option value="" disabled selected>Pick a team</option>
				</select><br>
				<select name="redTeam3" id="redTeam3" class="teamSelect" required>
					<option value="" disabled selected>Pick a team</option>
				</select>
			</fieldset>
			
			<fieldset id="blueAllianceForm" class="allianceForm">
				<h3>BLUE ALLIANCE</h3>
				<select name="blueTeam1" id="blueTeam1" class="teamSelect" required>
					<option value="" disabled selected>Pick a team</option>
				</select><br>
				<select name="blueTeam2" id="blueTeam2" class="teamSelect" required>
					<option value="" disabled selected>Pick a team</option>
				</select><br>
				<select name="blueTeam3" id="blueTeam3" class="teamSelect" required>
					<option value="" disabled selected>Pick a team</option>
				</select>
			</fieldset>
			<br>
			<div style="text-align: center;">
				<label for="playDefense">Simulate defense?: </label>
				<input type="checkbox" id="playDefense" name="playDefense"><br>
			</div>
			<input type="submit" value="Begin match!">
		</form>
		
		<div id="simMatchResults">
			<h2 id="projection"></h2>
			<h3>Ramageddon Match Simulation</h3>
			<div id="redResults" class="simTeamResults">
				<div class="simDataBox" id="simRedTeams">
					
					<!-- Red Team numbers go here-->
					
				</div>
				<div class="simDataBox" id="simRedScore">
					
					<!-- Red Gen Data goes here-->
					
				</div>
				<br>
				<div class="simBreakdownBox">
					<div class="simRPBox">
						Win
					</div>
					<div class="simRPBox">
						Hang
					</div>
					<div class="simRPBox">
						Stg. 3
					</div>
					<div id="simRedBreakdown">
						<!-- Red Gen Data goes here-->
					</div>
				</div>
			</div>
			<div id="blueResults" class="simTeamResults">
				<div class="simDataBox" id="simBlueScore">
					<!-- Blue score in h2 tags goes here-->
				</div>
				<div class="simDataBox" id="simBlueTeams">
					
					<!-- Blue Team numbers go here-->
					
				</div>
				<br>
				<div class="simBreakdownBox">
					<div class="simRPBox">
						Win
					</div>
					<div class="simRPBox">
						Hang
					</div>
					<div class="simRPBox">
						Stg. 3
					</div>
					<div id="simBlueBreakdown">
						<!-- Blue Gen Data goes here-->
					</div>
				</div>
			</div>
		</div>
		
		<div class="buttonList">
			<a href="master_main.html">Go back</a>
		</div>
	</body>
	<script type="text/javascript" src="../script/get_team_name.js"></script>
	<script type="text/javascript" src="../script/calculate_rpi.js"></script>
	<script>
		window.addEventListener('load', function() {
			var form = document.getElementById("simulateForm");
			// On submit, do stuff
			form.onsubmit = function(e) {
				e.preventDefault();
				// Simulate the match by evaluating RPIs of each team and drawing up a predicted match score
				
				// Grab team numbers
				var teamnoR1 = document.getElementById("redTeam1").value;
				var teamnoR2 = document.getElementById("redTeam2").value;
				var teamnoR3 = document.getElementById("redTeam3").value;
				var teamnoB1 = document.getElementById("blueTeam1").value;
				var teamnoB2 = document.getElementById("blueTeam2").value;
				var teamnoB3 = document.getElementById("blueTeam3").value;
				var playDefense = document.getElementById("playDefense").checked;
				
				// Define team statistics in objects
				var redScore = 0, blueScore = 0;
				var redAuto = 0, blueAuto = 0;
				var redAutoCellsScored = 0, blueAutoCellsScored = 0;
				var redStageCapacity = 0, blueStageCapacity = 0;
				var redPower = 0, bluePower = 0;
				var redPanel = 0, bluePanel = 0;
				var redEndgame = 0, blueEndgame = 0;
				var redBalanced = false, blueBalanced = false;
				var redRP = [false, false, false], blueRP = [false, false, false];
				var redAllRP = 0, blueAllRP = 0;
				var red = [
					{
						teamno: teamnoR1,
						rpi: get_stat(teamnoR1, "rpi"),
						auto: get_stat(teamnoR1, "auto"),
						powerport: get_stat(teamnoR1, "powerport"),
						cp: get_stat(teamnoR1, "cp"),
						endgame: get_stat(teamnoR1, "endgame"),
						defense: get_stat(teamnoR1, "defense")
					},
					{
						teamno: teamnoR2,
						rpi: get_stat(teamnoR2, "rpi"),
						auto: get_stat(teamnoR2, "auto"),
						powerport: get_stat(teamnoR2, "powerport"),
						cp: get_stat(teamnoR2, "cp"),
						endgame: get_stat(teamnoR2, "endgame"),
						defense: get_stat(teamnoR2, "defense")
					},
					{
						teamno: teamnoR3,
						rpi: get_stat(teamnoR3, "rpi"),
						auto: get_stat(teamnoR3, "auto"),
						powerport: get_stat(teamnoR3, "powerport"),
						cp: get_stat(teamnoR3, "cp"),
						endgame: get_stat(teamnoR3, "endgame"),
						defense: get_stat(teamnoR3, "defense")
					}
				]
				var blue = [
					{
						teamno: teamnoB1,
						rpi: get_stat(teamnoB1, "rpi"),
						auto: get_stat(teamnoB1, "auto"),
						powerport: get_stat(teamnoB1, "powerport"),
						cp: get_stat(teamnoB1, "cp"),
						endgame: get_stat(teamnoB1, "endgame"),
						defense: get_stat(teamnoB1, "defense")
					},
					{
						teamno: teamnoB2,
						rpi: get_stat(teamnoB2, "rpi"),
						auto: get_stat(teamnoB2, "auto"),
						powerport: get_stat(teamnoB2, "powerport"),
						cp: get_stat(teamnoB2, "cp"),
						endgame: get_stat(teamnoB2, "endgame"),
						defense: get_stat(teamnoB2, "defense")
					},
					{
						teamno: teamnoB3,
						rpi: get_stat(teamnoB3, "rpi"),
						auto: get_stat(teamnoB3, "auto"),
						powerport: get_stat(teamnoB3, "powerport"),
						cp: get_stat(teamnoB3, "cp"),
						endgame: get_stat(teamnoB3, "endgame"),
						defense: get_stat(teamnoB3, "defense")
					}
				]
				
				// Calculate the autonomous score of each alliance (easily done, since no defense can be played)
				redAuto = red[0].auto[0] + red[1].auto[0] + red[2].auto[0];
				redStageCapacity += Math.min(9, red[0].auto[1] + red[1].auto[1] + red[2].auto[1]);	// only 9 max can be achieved towards capacity in auto
				
				blueAuto = blue[0].auto[0] + blue[1].auto[0] + blue[2].auto[0];
				blueStageCapacity += Math.min(9, blue[0].auto[1] + blue[1].auto[1] + blue[2].auto[1]);
				
				// BZZZZT... DING DING DINGGGG
				// Run teleop simulation and modify team's outputs based on defense
				// Defensive bots will be targeting robots with higher RPIs. Bots with wills of .8 or higher will always play defense
				if (playDefense) {
					// TODO program defense
				} else {
					// Simulate red scoring
					redPower = red[0].powerport[0] + red[1].powerport[0] + red[2].powerport[0];
					redStageCapacity = red[0].powerport[1] + red[1].powerport[1] + red[2].powerport[1];
					let cp2 = false, cp3 = false;
					for (var i = 0; i < red.length; i ++) {
						if (red[i].cp[0]) cp2 = true;
						if (red[i].cp[1]) cp3 = true;
					}
					if (redStageCapacity >= 29) redPanel = 10;
					if (redStageCapacity >= 49) {
						redPanel = 30;
						redRP[2] = true;
					}
					
					// Simulate blue scoring
					bluePower = blue[0].powerport[0] + blue[1].powerport[0] + blue[2].powerport[0];
					blueStageCapacity = blue[0].powerport[1] + blue[1].powerport[1] + blue[2].powerport[1];
					cp2 = false; cp3 = false;
					for (i = 0; i < blue.length; i ++) {
						if (blue[i].cp[0]) cp2 = true;
						if (blue[i].cp[1]) cp3 = true;
					}
					if (blueStageCapacity >= 29) bluePanel = 10;
					if (blueStageCapacity >= 49) {
						bluePanel = 30;
						blueRP[2] = true;
					}
				}
				
				// Simulate endgame scoring
				// Red endgame
				var balancers = 0;
				for (i = 0; i < red.length; i ++) {
					if (red[i].endgame[0] == "Parked") redEndgame += 5;
					if (red[i].endgame[1] == true) balancers ++;
				}
				if (balancers < 2) {
					// No balancing, just take all climb points available
					for (i = 0; i < red.length; i ++) {
						if (red[i].endgame[0] == "Hanging") redEndgame += 25;
					}
				} else {
					// Take as many climbers as there are balancers, park the others
					for (i = 0; i < red.length; i ++) {
						if (red[i].endgame[0] == "Hanging" && !red[i].endgame[1]) {
							redEndgame += 5;
							red[i].endgame[0] == "Parked";
						} else if (red[i].endgame[0] == "Hanging" && red[i].endgame[1]) {
							redEndgame += 25;
						}
					}
					redEndgame += 15;
					redBalanced = true;
				}
				if (redEndgame >= 65) redRP[1] = true;
				
				// Blue endgame
				balancers = 0;
				for (i = 0; i < blue.length; i ++) {
					if (blue[i].endgame[0] == "Parked") blueEndgame += 5;
					if (blue[i].endgame[1] == true) balancers ++;
				}
				if (balancers < 2) {
					// No balancing, just take all climb points available
					for (i = 0; i < blue.length; i ++) {
						if (blue[i].endgame[0] == "Hanging") blueEndgame += 25;
					}
				} else {
					// Take as many climbers as there are balancers, park the others
					for (i = 0; i < blue.length; i ++) {
						if (blue[i].endgame[0] == "Hanging" && !blue[i].endgame[1]) {
							blueEndgame += 5;
							blue[i].endgame[0] == "Parked";
						} else if (blue[i].endgame[0] == "Hanging" && blue[i].endgame[1]) {
							blueEndgame += 25;
						}
					}
					blueEndgame += 15;
					blueBalanced = true;
				}
				if (blueEndgame >= 65) blueRP[1] = true;
				
				// Tally final scores
				redScore = redAuto + redPower + redPanel + redEndgame;
				blueScore = blueAuto + bluePower + bluePanel + blueEndgame;
				if (redScore > blueScore) redRP[0] = true; else blueRP[0] = true;
				for (i = 0; i < redRP.length; i ++) {
					if (redRP[i]) {
						redAllRP ++;
						if (i == 0) redAllRP ++;
					}
				}
				for (i = 0; i < blueRP.length; i ++) {
					if (blueRP[i]) {
						blueAllRP ++;
						if (i == 0) blueAllRP ++;
					}
				}
				
				// Assemble display, starting with projection
				var disp = document.getElementById("projection");
				disp.innerHTML = "";
				document.getElementById("simMatchResults").style.display = "block";
				var dispString = ""
				if (redScore - 3 > blueScore)
					dispString = "<h2>RED ALLIANCE PROJECTED TO WIN</h2>";
				else if (blueScore - 3 > redScore)
					dispString = "<h2>BLUE ALLIANCE PROJECTED TO WIN</h2>";
				else dispString = "<h2>MATCH IS A TOSSUP</h2>";
				disp.innerHTML = dispString;
				
				// Display each team
				var ds = "";
				for (i = 0; i < red.length; i ++) {
					ds += "<p>" + red[i].teamno + "</p>"
				}
				document.getElementById("simRedTeams").innerHTML = ds;
				ds = "";
				for (i = 0; i < blue.length; i ++) {
					ds += "<p>" + blue[i].teamno + "</p>"
				}
				document.getElementById("simBlueTeams").innerHTML = ds;
				
				// Display scores
				document.getElementById("simRedScore").innerHTML = "<h3>" + redScore + "</h3>";
				document.getElementById("simBlueScore").innerHTML = "<h3>" + blueScore + "</h3>";
				
				// Light up RP indicators
				var rpBoxes = document.getElementsByClassName("simRPBox");
				for (i = 0; i < 3; i ++) {
					if (redRP[i]) rpBoxes[i].classList.add("complete"); else rpBoxes[i].classList.remove("complete");
				}
				for (i = 0; i < 3; i ++) {
					if (blueRP[i]) rpBoxes[i + 3].classList.add("complete"); else rpBoxes[i + 3].classList.remove("complete");
				}
				
				// Display match statistics
				// Red stats
				ds = "";
				ds += "<p><strong>" + redAllRP + " RP</strong></p>";
				ds += "<p>Auto: " + redAuto + "</p>";
				ds += "<p>Power Cells: " + redPower + "</p>";
				ds += "<p>Control Panel: " + redPanel + "</p>";
				ds += "<p>Endgame: " + redEndgame + "</p>";
				document.getElementById("simRedBreakdown").innerHTML = ds;
				
				// Blue stats
				ds = "";
				ds += "<p><strong>" + blueAllRP + " RP</strong></p>";
				ds += "<p>Auto: " + blueAuto + "</p>";
				ds += "<p>Power Cells: " + bluePower + "</p>";
				ds += "<p>Control Panel: " + bluePanel + "</p>";
				ds += "<p>Endgame: " + blueEndgame + "</p>";
				document.getElementById("simBlueBreakdown").innerHTML = ds;
			}
		});
		
		// Does all the dirty work of collecting all the forms needed to calculate game statistics. stat indicates via string which statistic is needed
		function get_stat(teamno, stat) {
			var forms = get_team_forms(teamno);
			switch (stat) {
				case "rpi":
					return calculate_rpi(forms, false, false, "", false, "")[0];
				case "auto":
					// Returns an array with points scored and # pieces scored
					var autocross = 0, autolow = 0, autohigh = 0;
					var allForms = 0;
					for (i = 0; i < forms.length; i ++) {
						// Exceptions
						if (forms[i].formtype == "verbal") continue;
						allForms ++;
						autocross += Number(forms[i].autocross);
						autolow += Number(forms[i].autolow);
						autohigh += Number(forms[i].autohigh);
					}
					if (autocross > 3.6) autocross = 5; else autocross = 0;
					autolow = Math.round(autolow / allForms);
					autohigh = Math.round(autohigh / allForms);
					return [autocross + autolow * 2 + autohigh * 4, autolow + autohigh];
				case "powerport":
					// Returns an array with points scored and # pieces scored
					var lowport = 0, highport = 0;
					var allForms = 0;
					for (i = 0; i < forms.length; i ++) {
						// Exceptions
						if (forms[i].formtype == "verbal") continue;
						allForms ++;
						lowport += Number(forms[i].lowport);
						highport += Number(forms[i].highport);
					}
					lowport = Math.round(lowport / allForms)
					highport = Math.round(highport / allForms);
					return [lowport + highport * 2, lowport + highport];
				case "cp":
					// Returns an array for both stage 2 or stage 3 with either true or false depending on whether or not the team can spin the control panel
					var cp2 = false, cp3 = false, verbals = false;
					for (i = 0; i < forms.length; i ++) {
						// Exceptions
						if (forms[i].formtype == "match") continue;
						verbals = true;
						if (forms[i].cp2 == "true") cp2 = true;
						if (forms[i].cp3 == "true") cp3 = true;
					}
					if (!verbals) {
						// No verbal forms have been submitted for the team so we have to see based on match data if they can spin the panel
						for (i = 0; i < forms.length; i ++) {
							if (forms[i].cp2 == "1") cp2 = true;
							if (forms[i].cp3 == "1") cp3 = true;
						}
					}
					return [cp2, cp3];
				case "endgame":
					// Calculates endgame scoring with an array containing a string for what the team did and whether or not they can potentially balance the switch with a partner
					var climb = "-", level = false;
					var climbno = 0, parkno = 0, levelno = 0;
					var allForms = 0;
					for (i = 0; i < forms.length; i ++) {
						// Exceptions
						if (forms[i].formtype == "verbal") continue;
						allForms ++;
						if (forms[i].climb == "1") parkno ++;
						if (forms[i].climb == "2") climbno ++;
						if (forms[i].climblevel == "1") levelno ++;
					}
					if (parkno > climbno) climb = "Parked";
					if (climbno > parkno) climb = "Hanging";
					if (parkno + climbno < Math.ceil(allForms * .5)) climb = "-";
					if (levelno <= 1 && allForms > 4) level = false;	// we can reasonably assume that they probably can't level most of the time if they only did it one out of four times
					else if (levelno >= 1) level = true;
					return [climb, level];
				case "defense":
					// Calculates the defensive strength of a team and whether or not they're likely to play any defense
					// Defensive ability is returned by a number estimating the number of game pieces the defender can prevent the offense from scoring. Teams that would rather not play defense (and don't very often) will receive low ratings due to an inferred timid nature, and teams that are willing will rate higher. Teams that frequently play defense will receive a higher rating even if the quality isn't strong every time
					var drate = 0, dwill = 0;	// defensive power rating, odds that team will want to play defense (between 0 and 1)
					var verbals = false;
					
					// First evaluate the verbal reports. If a team expresses no desire to defend, all values can be returned as 0
					for (i = 0; i < forms.length; i ++) {
						// Exceptions
						if (forms[i].formtype == "match") continue;
						verbals = true;
						if (forms[i].defense == "0") return [0, 0];	// not a chance
						if (forms[i].defense == "1") {				// team would rather not
							dwill = .08;
							drate = -2;
						}
						if (forms[i].defense == "2") {				// team is able and willing
							dwill = .14;	
							drate = 3;
						}
					}
					
					// Count how many times the team has been reported playing defense
					var allcount = 0, dcount = 0, dpoor = 0, dstrong = 0;
					for (i = 0; i < forms.length; i ++) {
						// Exceptions
						if (forms[i].formtype == "verbal") continue;
						allcount ++;
						if (forms[i].defenserate == "1") dpoor ++;
						if (forms[i].defenserate == "2") dstrong ++;
						if (forms[i].defense == "1") dcount ++;
					}
					// Will to play defense is defined by (between 0 and 1) OG will + time on defense^2 / (3.5 * all matches)
					dwill += Math.max(0, Math.min(1, Math.pow(dcount, 2) / (3.5 * allcount)));
					// Defensive strength calculated by 2.5 * SQRT((# times on D * 1/2 * strong D games + 1) * (3 / poor D games + 1))
					drate += Math.round(2.5 * Math.sqrt((dcount * .5 * (dstrong + 1)) * (3 / (dpoor + 1))));
					drate = Math.max(3, Math.min(drate, 20));	// theoretical max game piece blocking is 20, minimum is 3
					return [drate, dwill];
					break;
			}
			return 0;
		}
		
		// Takes a team number and returns an array of all its forms
		function get_team_forms(teamno) {
			// Grab team list and form ID list
			var teamList = JSON.parse(localStorage.teamList);
			var formList = JSON.parse(localStorage.formList);
			var indexList = [];

			// Select all forms containing this team
			for (var i = 0; i < teamList.length; i ++) {
				if (teamList[i] == teamno) indexList.push(i);
			}

			var formArray = [];

			// Package all relevant forms
			for (var i = 0; i < indexList.length; i ++) {
				thisID = "form-" + teamno + "-" + formList[indexList[i]];
				var myJSON = localStorage.getItem(thisID);
				var myForm = JSON.parse(myJSON);
				formArray.push(myForm);
			}
			
			return formArray;
		}
		
		function load_data() {
			if (localStorage.masterInit) {
				// Show the team numbers that have data
				var teamsWithData = JSON.parse(localStorage.teamsWithData);
				var teamLists = document.getElementsByClassName("teamSelect");

				Array.prototype.forEach.call(teamLists, function(list) {
					// Do stuff here
					for (var i = 0; i < teamsWithData.length; i ++) {
						list.innerHTML += '<option value="' + teamsWithData[i] + '">' + teamsWithData[i] + '</option>';
					}
				});
			}
		}
	</script>
</html>
